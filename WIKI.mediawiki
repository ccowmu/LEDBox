'''LEDBox''' is the NeoPixel LED lighting system for the CCaWMU office. It drives a 300-pixel LED strip that can be controlled remotely through Matrix chat commands.

== How It Works ==

<pre>
┌──────────────┐   $led red    ┌──────────────────┐   poll 5s   ┌─────────────┐       ┌──────────────┐
│  Matrix Chat │ ────────────▶ │  Server (yakko)  │ ◀───────── │  LEDBox Pi  │ ────▶ │  300 NeoPixel │
│  $led / $rgb │               │  :8878           │ ─────────▶ │  (LEDbox)   │       │  LED Strip   │
└──────────────┘               └──────────────────┘             └─────────────┘       └──────────────┘
</pre>

# A user sends a command in Matrix chat (e.g. <code>$led red</code>, <code>$led rainbow</code>, <code>$led chase</code>)
# The chatbot POSTs the color/mode to the server at <code>yakko.cs.wmich.edu:8878</code>
# The LEDBox Pi polls the server every 5 seconds for the current state
# The Pi drives the NeoPixel strip with the requested color or animation

== Animation Modes ==

{| class="wikitable"
|-
! Mode !! Command !! Behavior
|-
| '''Color''' || <code>$led red</code> / <code>$rgb 255 0 0</code> || Wipes the solid color across the strip, then fades to black
|-
| '''Chase''' || <code>$led chase</code> || Theater-style chasing lights in the current color
|-
| '''Rainbow''' || <code>$led rainbow</code> || Full rainbow cycle across all 300 pixels
|-
| '''Random''' || <code>$led random</code> || Randomly picks between rainbow, chase, and color with random colors
|}

== Hardware ==

{| class="wikitable"
|-
! Component !! Details
|-
| '''Computer''' || Raspberry Pi 3 Model B+
|-
| '''Hostname''' || <code>LEDbox</code>
|-
| '''IP Address''' || <code>192.168.1.194</code>
|-
| '''LED Strip''' || 300x WS2812B (NeoPixel) — GRB color order
|-
| '''Data Pin''' || GPIO 18 (PWM)
|-
| '''Brightness''' || 255 (max)
|}

=== LED Strip Parameters ===

{| class="wikitable"
|-
! Parameter !! Value
|-
| Pixel Count || 300
|-
| Signal Frequency || 800 kHz
|-
| DMA Channel || 10
|-
| PWM Channel || 0
|-
| Color Order || GRB
|}

== Software ==

All source code lives in one repo: '''[https://github.com/ccowmu/LEDBox github.com/ccowmu/LEDBox]'''

The Pi automatically mirrors this repo. Push to <code>main</code> and the changes go live within 60 seconds — no SSH required.

=== Repository Contents ===

<pre>
LEDBox/
├── updatecolors.py        # Main controller — polls server, drives NeoPixels
├── ledbox.service          # Systemd unit for the controller
├── ledbox-sync.sh          # Auto-sync script (fetch + reset + restart)
├── ledbox-sync.service     # Systemd unit for sync
├── ledbox-sync.timer       # Runs sync every 60 seconds
├── .env                    # API key (gitignored)
└── .gitignore
</pre>

=== Systemd Services ===

{| class="wikitable"
|-
! Service !! What It Does
|-
| <code>ledbox.service</code> || Runs the controller as root (required for GPIO/PWM). Starts on boot, restarts on failure.
|-
| <code>ledbox-sync.timer</code> || Every 60s: pulls from GitHub, restarts controller if code changed.
|}

=== Auto-Sync (GitHub → Pi) ===

The <code>ledbox-sync.sh</code> script runs every minute via systemd timer:

# <code>git fetch origin main</code>
# Compares local HEAD to remote — if identical, does nothing
# If there are changes: <code>git reset --hard origin/main</code>
# Checks if any <code>.service</code> or <code>.timer</code> files changed — if so, copies them to <code>/etc/systemd/system/</code> and reloads systemd
# Restarts <code>ledbox.service</code>

'''To deploy a change:''' just push to <code>main</code> on GitHub. Done.

== Server API ==

The LEDBox Pi polls the same Office-IoT server as doorbot (<code>yakko.cs.wmich.edu:8878</code>).

=== GET / (status polling) ===

Returns the current LED state:

<pre>
{
  "red": 255,
  "green": 0,
  "blue": 0,
  "type": "color",
  "letmein": false,
  "timestamp": 1707700000
}
</pre>

The <code>type</code> field determines the animation mode: <code>color</code>, <code>chase</code>, <code>rainbow</code>, or <code>random</code>.

=== POST / (control — from chatbot) ===

<pre>
{
  "status": {
    "red": 255,
    "green": 0,
    "blue": 0,
    "type": "rainbow"
  }
}
</pre>

== Common Commands ==

<pre>
# SSH into the Pi
ssh pi@192.168.1.194

# Check if the controller is running
sudo systemctl status ledbox

# View live logs
sudo journalctl -u ledbox -f

# Restart the controller
sudo systemctl restart ledbox

# Force an immediate sync from GitHub
/home/pi/LEDBox/ledbox-sync.sh

# Check sync timer status
systemctl status ledbox-sync.timer

# Test server connection
curl -H "Authorization: Bearer $YAKKO_API_KEY" http://yakko.cs.wmich.edu:8878/
</pre>

== Architecture Notes ==

* The controller runs as '''root''' because the <code>rpi_ws281x</code> library requires root access for PWM/DMA hardware control
* The background thread polls the server every '''5 seconds''' for state changes
* Animations are blocking — the current animation runs to completion before checking for new state, so there can be a delay between sending a command and seeing the change
* The API key is stored in <code>/home/pi/LEDBox/.env</code> (not in the repo)

== Troubleshooting ==

'''LEDs not responding:'''

<pre>
sudo systemctl status ledbox           # Is the service running?
sudo journalctl -u ledbox -n 50        # Check recent logs
</pre>

'''Wrong colors / flickering:'''
* The strip uses '''GRB''' color order — if colors look swapped, check the <code>ORDER</code> constant
* Ensure the Pi has adequate power — a 300-pixel strip at full brightness draws significant current
* Check GPIO 18 connection to the data line

'''Service won't start:'''
* Must run as root (the <code>rpi_ws281x</code> library needs DMA access)
* Check that <code>python3</code>, <code>rpi_ws281x</code>, and <code>requests</code> are installed

'''Sync not working:'''

<pre>
systemctl status ledbox-sync.timer     # Is the timer active?
sudo journalctl -u ledbox-sync -n 20   # Check sync logs
git -C /home/pi/LEDBox fetch origin    # Can it reach GitHub?
</pre>

== Network ==

{| class="wikitable"
|-
! Endpoint !! Address
|-
| '''Server API''' || http://yakko.cs.wmich.edu:8878
|-
| '''Pi SSH''' || <code>pi@192.168.1.194</code>
|-
| '''Source Code''' || [https://github.com/ccowmu/LEDBox github.com/ccowmu/LEDBox]
|}

== See Also ==

* [[Door_Bot]] — the office door lock system, controlled by the same server
* [https://github.com/ccowmu/Office-IoT Office-IoT] — the server that both LEDBox and Door Bot poll
